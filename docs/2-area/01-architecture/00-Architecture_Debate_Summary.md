# [토론] Antigravity 아키텍처 진화: 레드팀 vs 블루팀

## 요약

본 문서는 **포커스 & 선택** 책임의 OS 레이어 위임, 수동 **Zone 토폴로지** 제거, 그리고 커맨드에 대한 **명시적 페이로드 해결(Explicit Payload Resolution)** 패턴 채택에 관한 아키텍처 논쟁을 종합합니다.

---

## 🏗 주제 1: Zone 토폴로지 & 아이템 탐색
**배경**: 수동 props (`defaultFocusId`, `neighbors`, `items`)에서 자동 DOM 추론 및 공간 탐색(Spatial Navigation)으로의 전환.

### 🔵 블루팀 (변경 찬성)
- **제로 설정**: "Zone은 그냥 동작해야 한다." 개발자가 `items` 배열이나 `neighbors` 맵을 수동으로 관리할 필요 없음.
- **단일 진실 공급원**: DOM *자체가* 레이아웃. `data-item-id`로 아이템을 추론하면 탐색이 실제 시각적 배치와 일치함.
- **확장성**: 공간 탐색은 하드코딩된 이웃 링크보다 동적 레이아웃(grid, flex)을 더 잘 처리함.

### 🔴 레드팀 (안정성 우선)
- **예측 불가 위험**: DOM 쿼리는 고빈도 업데이트 중 느리거나 일관성이 없을 수 있음. 명시적 props는 O(1)이며 결정론적.
- **초기 포커스 모호성**: `defaultFocusId` 없이 시스템이 진입점을 추측해야 함 (첫 DOM 노드?), 특수 워크플로에서 잘못된 선택 가능.
- **마이그레이션 비용**: 코드베이스의 모든 `Zone` 사용처를 리팩토링해야 함.

**✅ 결정**: **블루 전략 채택**. 수동 토폴로지 유지보수 부담이 예측 가능성 위험보다 큼. 폴백 메커니즘(첫 DOM 아이템)과 견고한 `공간 탐색`(이미 구현됨)이 레드팀 우려를 완화.

> **현재 구현 상태**: `src/os/features/focus/pipeline/3-resolve/`에서 Config-Driven 방식으로 구현 완료.

---

## 🎯 주제 2: 포커스 & 선택 위임
**배경**: `selectedCategoryId`와 `focusId` 책임을 앱 상태에서 OS `FocusGroupStore`로 이전.

### 🔵 블루팀 (아키텍처 순수성)
- **관심사 분리**: "선택"은 물리적 UI 상태. 비즈니스 로직 레이어는 *어떤 아이템이 강조됐는지*가 아니라 *어떤 작업을 수행할지*만 알면 됨.
- **성능**: 포커스 업데이트를 OS 레이어로 격리하여 단순 커서 이동에 대한 대규모 React 트리 리렌더링 방지.
- **보일러플레이트 감소**: `onSelect`, `activeId`, `setFocus` props 드릴링 불필요.

### 🔴 레드팀 (도메인 무결성)
- **의미론적 손실**: "선택"은 비즈니스 의도 (예: "현재 컨텍스트")를 암시하는 경우가 많으며, 단순 "커서 위치"가 아님. OS에 완전 위임하면 이 뉘앙스 상실 가능.
- **테스트 어려움**: 헤드리스 로직 테스트가 명시적 인자 대신 전역 OS 스토어에 암묵적으로 의존하면 어려워짐.

**✅ 결정**: **하이브리드 접근 (블루 기울기)**. *활성* 커서/포커스는 OS에 위임. 비즈니스 로직은 커맨드를 통해 *결과* (Target ID)만 수신. 서비스 레이어는 OS가 해결(Resolution)을 통해 올바른 ID를 제공할 것을 신뢰.

---

## 🔌 주제 3: 순수 페이로드 & OS.FOCUS 센티넬
**배경**: `env` 주입과 `FocusObject`를 커맨드에서 제거하고, 명시적 `OS.FOCUS` 페이로드 센티넬 채택.

### 🔵 블루팀 (명시성 & 순수성)
- **순수 함수**: 커맨드 리듀서는 `(State, Payload) => State`이어야 함. 숨겨진 `env` 세 번째 인자 없음.
- **의도 명확성**: `DeleteTodo({ id: OS.FOCUS })`는 "포커스된 아이템을 삭제하겠다"는 의도를 명확히 표현. 암묵적 누락 ID 채우기는 마법적이고 버그 유발.
- **미들웨어 해결**: 해결(Resolution)은 커맨드 실행 *전에* 발생. 리듀서는 `OS.FOCUS`를 보지 않고, 구체적인 `id`만 볼 수 있음.

### 🔴 레드팀 (단순성)
- **과도한 엔지니어링?**: "그냥 ID를 넘기면 되지 않나?" 모든 곳에서 명시적으로 `id`를 넘기는 것이 해결 미들웨어를 만드는 것보다 단순.
- **타입 복잡성**: 페이로드를 `number | typeof OS.FOCUS`로 정의하면 단순 커맨드에서 타입 마찰 추가.

**✅ 결정**: **블루 전략 채택 (명시적 센티넬)**. 명확성과 순수성의 이득이 상당함. 어디서든 (메뉴, 단축키, 음성) 트리거될 수 있는 "컨텍스트 프리" 커맨드를 가능하게 하면서 핵심 로직을 시각적으로 결정론적으로 유지.

---

## 📝 최종 아키텍처 표준
1. **Zone**: DOM 기반 자동 설정. 수동 토폴로지 props 없음.
2. **커맨드**: 순수 리듀서 `(State, Payload) => State`.
3. **디스패치**: 컨텍스트 의존 액션에 `OS.FOCUS` 센티넬 사용. 미들웨어가 구체적 ID로 해결.

**상태**: ✅ 구현 완료. `src/os/features/command/` 참조.
