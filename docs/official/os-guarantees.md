# OS Guarantees — 데이터 조작 후 상태 보장 명세

> W3C APG가 "키보드 탐색 행동"을 정의하듯, 이 문서는 "데이터 조작 후 OS가 보장하는 상태"를 정의한다.
> APG에 해당하는 국제 표준은 없다. macOS HIG / Windows UIA / GNOME GTK의 공통분모에서 추출.

---

## §0 근본 원칙

> **선택과 포커스는 변화를 따라간다.**

| 변화 유형 | 포커스 | 선택 |
|----------|--------|------|
| 아이템 사라짐 (삭제, 컷) | recovery: 다음/이전 | 클리어 |
| 아이템 이동 (Move) | 이동된 아이템 따라감 | 유지 |
| 아이템 생성 (Paste) | 생성된 아이템으로 | 생성된 것들 |
| 상태 되돌림 (Undo/Redo) | 되돌린 지점으로 | 되돌린 상태 |
| 속성 변경 (Check, Field Commit) | 변화 없음 (위치 불변) | 변화 없음 |
| 구조 변경 (Expand/Collapse) | 부모 유지 (변화 주체) | 변화 없음 |

모든 OS 보장은 이 원칙의 구체적 적용이다.

---

## §1 Delete + Focus Recovery

> 구현: `RECOVER` 커맨드 + `recoveryTargetId` (NAVIGATE가 사전 계산)

| # | 조건 | 보장 |
|:-:|------|------|
| 1.1 | 단일 아이템 삭제 (중간 위치) | 포커스 → 다음 아이템 |
| 1.2 | 마지막 아이템 삭제 | 포커스 → 이전 아이템 |
| 1.3 | 유일한 아이템 삭제 | RECOVER no-op (stale pointer). 재진입 시 정리됨 |
| 1.4 | 멀티선택 삭제 | 포커스 → recoveryTargetId (삭제 범위 바로 다음) |
| 1.5 | 삭제 후 selection | selection = [] (항상 비워짐) |

## §2 Clipboard

| # | 조건 | 보장 |
|:-:|------|------|
| 2.1 | Copy | 포커스/선택 변화 없음 (§0: 변화 없으면 유지) |
| 2.2 | Cut (단일) | §1.1과 동일 + selection 클리어 |
| 2.3 | Cut (멀티) | §1.4와 동일 + selection 클리어 |
| 2.4 | Paste | 포커스 → 마지막 붙여넣은 항목 (§0: 생성 따라감) |

## §3 Multi-Select + 작업

| # | 조건 | 보장 |
|:-:|------|------|
| 3.1 | 선택 일부 삭제 | selection = [] (§1.5) |
| 3.2 | 빈 selection에서 Delete | 포커스 아이템만 삭제 (§1.1/1.2) |
| 3.3 | 전체 삭제 | 빈 리스트 (§1.3) |

## §4 Move (재배치)

> 구현: `OS_MOVE_UP/DOWN` → `onMoveUp/Down(cursor)` 앱 콜백 위임

| # | 조건 | 보장 |
|:-:|------|------|
| 4.1 | 아이템 위로 이동 | 포커스 → 이동된 아이템 (§0: 위치 변화 따라감) |
| 4.2 | 아이템 아래로 이동 | 포커스 → 이동된 아이템 |
| 4.3 | 첫 번째에서 위로 이동 | no-op (경계) |
| 4.4 | 마지막에서 아래로 이동 | no-op (경계) |
| 4.5 | 이동 후 selection | selection 유지 (같은 아이템) |

## §5 Undo / Redo

> 구현: `OS_UNDO/REDO` → `onUndo/onRedo` 앱 콜백 위임
> Note: Undo/Redo는 앱 상태를 복원하지만, **포커스/선택의 복원은 앱 책임**.
> OS는 Undo/Redo 후 `RECOVER`가 동작하도록 보장.

| # | 조건 | 보장 |
|:-:|------|------|
| 5.1 | Undo (삭제 되돌림) | OS: RECOVER 동작 보장. 앱: 복원된 아이템에 포커스 |
| 5.2 | Undo (추가 되돌림) | OS: RECOVER 동작 보장. 앱: 남은 아이템에 포커스 |
| 5.3 | Redo | §5.1/5.2의 역 |

## §6 Expand / Collapse

> 구현: `EXPAND` 커맨드 → `expandedItems` 상태 직접 변경

| # | 조건 | 보장 |
|:-:|------|------|
| 6.1 | 펼치기 (expand) | 포커스 = 부모 유지 (§0: 변화 주체에 머무름) |
| 6.2 | 접기 (collapse) | 포커스 = 부모 유지 |
| 6.3 | 접기 시 자식에 포커스 | 포커스 → 부모로 이동 (자식이 사라지므로 §0 적용) |

## §7 Field (편집 모드)

> 구현: `FIELD_START_EDIT` / `FIELD_COMMIT` / `FIELD_CANCEL`

| # | 조건 | 보장 |
|:-:|------|------|
| 7.1 | 편집 진입 (Enter) | `editingItemId = focusedItemId`. 포커스 유지 |
| 7.2 | 편집 완료 (Enter) | `editingItemId = null`. 포커스 → 같은 아이템 (§0: 위치 불변) |
| 7.3 | 편집 취소 (Escape) | `editingItemId = null`. 포커스 → 같은 아이템 |
| 7.4 | 편집 중 Navigate | 편집 먼저 커밋, 그 다음 이동 (또는 앱 정책) |

## §8 Check (토글)

> 구현: `OS_CHECK` → `onCheck(cursor)` 앱 콜백 위임

| # | 조건 | 보장 |
|:-:|------|------|
| 8.1 | 단일 체크 토글 | 포커스/선택 변화 없음 (§0: 위치 불변) |
| 8.2 | 멀티선택 후 체크 | 선택된 모든 아이템 토글 (앱 정책). 포커스/선택 유지 |
